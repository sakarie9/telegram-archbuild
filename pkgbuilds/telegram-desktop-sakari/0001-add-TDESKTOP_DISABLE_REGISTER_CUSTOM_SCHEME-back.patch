From f36e312f6b89c3e7f06033e4a9a0d3e238cf8bee Mon Sep 17 00:00:00 2001
From: Megumi_fox <i@megumifox.com>
Date: Wed, 14 Apr 2021 22:56:55 +0800
Subject: [PATCH 1/4] add TDESKTOP_DISABLE_REGISTER_CUSTOM_SCHEME back

---
 Telegram/SourceFiles/core/application.cpp        | 2 ++
 Telegram/SourceFiles/settings/settings_codes.cpp | 2 ++
 Telegram/cmake/telegram_options.cmake            | 5 +++++
 3 files changed, 9 insertions(+)

diff --git a/Telegram/SourceFiles/core/application.cpp b/Telegram/SourceFiles/core/application.cpp
index e24cb260ea..22a56374b7 100644
--- a/Telegram/SourceFiles/core/application.cpp
+++ b/Telegram/SourceFiles/core/application.cpp
@@ -1832,6 +1832,7 @@ void Application::startShortcuts() {
 }
 
 void Application::RegisterUrlScheme() {
+#ifndef TDESKTOP_DISABLE_REGISTER_CUSTOM_SCHEME
 	const auto arguments = Launcher::Instance().customWorkingDir()
 		? u"-workdir \"%1\""_q.arg(cWorkingDir())
 		: QString();
@@ -1857,6 +1858,7 @@ void Application::RegisterUrlScheme() {
 		.displayAppName = AppName.utf16(),
 		.displayAppDescription = AppName.utf16(),
 	});
+#endif // !TDESKTOP_DISABLE_REGISTER_CUSTOM_SCHEME
 }
 
 bool IsAppLaunched() {
diff --git a/Telegram/SourceFiles/settings/settings_codes.cpp b/Telegram/SourceFiles/settings/settings_codes.cpp
index 3ac02395a9..a4422d1212 100644
--- a/Telegram/SourceFiles/settings/settings_codes.cpp
+++ b/Telegram/SourceFiles/settings/settings_codes.cpp
@@ -164,6 +164,7 @@ auto GenerateCodes() {
 			window->showSettings(Settings::Folders::Id());
 		}
 	});
+#ifndef TDESKTOP_DISABLE_REGISTER_CUSTOM_SCHEME
 	codes.emplace(u"registertg"_q, [](SessionController *window) {
 		Core::Application::RegisterUrlScheme();
 		Ui::Toast::Show("Forced custom scheme register.");
@@ -177,6 +178,7 @@ auto GenerateCodes() {
 			? u"Fast buttons mode enabled."_q
 			: u"Fast buttons mode disabled."_q);
 	});
+#endif // !TDESKTOP_DISABLE_REGISTER_CUSTOM_SCHEME
 
 	auto audioFilters = u"Audio files (*.wav *.mp3);;"_q + FileDialog::AllFilesFilter();
 	auto audioKeys = {
diff --git a/Telegram/cmake/telegram_options.cmake b/Telegram/cmake/telegram_options.cmake
index 18fa73671a..0b5cce634c 100644
--- a/Telegram/cmake/telegram_options.cmake
+++ b/Telegram/cmake/telegram_options.cmake
@@ -5,6 +5,7 @@
 # https://github.com/telegramdesktop/tdesktop/blob/master/LEGAL
 
 option(TDESKTOP_API_TEST "Use test API credentials." OFF)
+option(TDESKTOP_DISABLE_REGISTER_CUSTOM_SCHEME "Disable automatic 'tg://' URL scheme handler registration." OFF) 
 set(TDESKTOP_API_ID "0" CACHE STRING "Provide 'api_id' for the Telegram API access.")
 set(TDESKTOP_API_HASH "" CACHE STRING "Provide 'api_hash' for the Telegram API access.")
 
@@ -48,6 +49,10 @@ if (DESKTOP_APP_USE_PACKAGED)
     target_compile_definitions(Telegram PRIVATE TDESKTOP_USE_PACKAGED)
 endif()
 
+if (TDESKTOP_DISABLE_REGISTER_CUSTOM_SCHEME)
+    target_compile_definitions(Telegram PRIVATE TDESKTOP_DISABLE_REGISTER_CUSTOM_SCHEME)
+endif()
+
 if (DESKTOP_APP_SPECIAL_TARGET)
     target_compile_definitions(Telegram PRIVATE TDESKTOP_ALLOW_CLOSED_ALPHA)
 endif()
-- 
2.51.0

